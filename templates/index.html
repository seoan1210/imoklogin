<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë£°ë › ëŒë¦¬ê¸°!</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ì „ì²´ì ì¸ ìŠ¤íƒ€ì¼ */
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            background: linear-gradient(135deg, #84fab0, #8fd3f4); /* ì‹œì›í•œ ê·¸ë¼ë°ì´ì…˜ ë°°ê²½ */
            color: #333;
        }
        .container { 
            background-color: #ffffff; 
            padding: 40px; 
            border-radius: 20px; /* ë” ë‘¥ê¸€ê²Œ */
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2); /* ê·¸ë¦¼ì ê°•í™” */
            text-align: center; 
            max-width: 500px; /* ì¢€ ë” ë„“ê²Œ */
            width: 90%; 
            position: relative;
            animation: fadeInScale 0.8s ease-out; /* ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ */
        }
        h1 { 
            color: #28a745; /* í¬ì¸íŠ¸ ìƒ‰ìƒ (ë…¹ìƒ‰) */
            margin-bottom: 25px; 
            font-size: 2.8em; /* ë” í¬ê²Œ */
            font-weight: 700;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }
        .user-info { 
            margin-bottom: 20px; 
            font-size: 1.2em; 
            color: #555; 
            font-weight: 700;
        }
        p { 
            color: #666; 
            margin-bottom: 20px; 
            font-size: 1.1em;
        }
        /* ë£°ë › ëŒë¦¬ê¸° ë²„íŠ¼ */
        button { 
            background-color: #ff6b6b; /* ê°•ë ¬í•œ ë¹¨ê°„ìƒ‰ */
            color: white; 
            padding: 18px 35px; /* ë” í¬ê²Œ */
            border: none; 
            border-radius: 50px; /* ì™„ì „ ë‘¥ê·¼ ë²„íŠ¼ */
            cursor: pointer; 
            font-size: 1.8em; /* í°íŠ¸ ì‚¬ì´ì¦ˆ í‚¤ìš°ê¸° */
            font-weight: 700;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; 
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2); /* ë²„íŠ¼ ê·¸ë¦¼ì ê°•í™” */
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-top: 30px;
        }
        button:hover { 
            background-color: #e63946; 
            transform: translateY(-5px) scale(1.02); /* í˜¸ë²„ ì‹œ ë” í¬ê²Œ ë°˜ì‘ */
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.3);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ë£°ë › ê²°ê³¼ í‘œì‹œ */
        #rouletteResult { 
            margin-top: 35px; 
            font-size: 1.8em; 
            font-weight: bold; 
            color: #ff6b6b; /* ê²°ê³¼ ìƒ‰ìƒ */
            min-height: 2em; /* ê²°ê³¼ê°€ ì—†ì–´ë„ ê³µê°„ ìœ ì§€ */
        }

        /* ì‚¬ëŒ ëª©ë¡ */
        #personList { 
            list-style-type: none; 
            padding: 0; 
            margin-top: 25px; 
            max-height: 200px; /* ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ë„ë¡ ë†’ì´ ì œí•œ */
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 10px;
            background-color: #fcfcfc;
        }
        #personList li { 
            background-color: #f0f8ff; /* ì—°í•œ í•˜ëŠ˜ìƒ‰ ë°°ê²½ */
            margin-bottom: 8px; 
            padding: 12px 20px; 
            border-radius: 8px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 1.05em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #personList li span { 
            font-weight: 700; 
            color: #007bff; /* íŒŒë€ìƒ‰ í‹°ì¼“ ìˆ˜ */
            font-size: 1.1em;
        }

        /* ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ */
        .logout-button { 
            position: absolute; 
            top: 20px; 
            right: 30px; 
            background-color: #6c757d; 
            padding: 10px 18px; 
            font-size: 1em; 
            box-shadow: none;
            border-radius: 8px; /* ëœ ë‘¥ê¸€ê²Œ */
            text-transform: none; /* ëŒ€ë¬¸ì ì•„ë‹˜ */
            font-weight: 400; /* ì¼ë°˜ í°íŠ¸ êµµê¸° */
        }
        .logout-button:hover { 
            background-color: #5a6268; 
            transform: none; 
            box-shadow: none; 
        }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        /* ë°˜ì‘í˜• ë””ìì¸ (ê°„ë‹¨í•˜ê²Œ) */
        @media (max-width: 480px) {
            .container {
                padding: 25px;
            }
            h1 {
                font-size: 2.2em;
            }
            button {
                padding: 15px 25px;
                font-size: 1.5em;
            }
            #rouletteResult {
                font-size: 1.5em;
            }
            .logout-button {
                top: 15px;
                right: 15px;
                padding: 8px 12px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="logout-button" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        <h1>ë£°ë › ëŒë¦¬ê¸°!</h1>
        <p class="user-info">í™˜ì˜í•©ë‹ˆë‹¤, {{ current_user.name }}ë‹˜!</p> 
        <p>í˜„ì¬ ë£°ë ›ê¶Œ í˜„í™©:</p>
        <ul id="personList">
            </ul>
        <button type="button" id="spinRouletteButton">ë£°ë › ëŒë¦¬ê¸°!</button>
        <p id="rouletteResult"></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const personListElement = document.getElementById('personList');
            const spinButton = document.getElementById('spinRouletteButton');
            const resultDisplay = document.getElementById('rouletteResult');

            const API_BASE_URL = window.location.origin;
            const API_GET_PEOPLE = API_BASE_URL + '/api/get_people';
            const API_SPIN_ROULETTE = API_BASE_URL + '/api/spin_roulette';
            const API_LOGOUT = API_BASE_URL + '/api/logout';

            // ì„œë²„ì—ì„œ ì§ì ‘ ë Œë”ë§ëœ current_user.name ê°’ì„ JavaScript ë³€ìˆ˜ë¡œ ì‚¬ìš©
            const loggedInUserName = "{{ current_user.name }}"; 

            async function fetchPeopleForRoulette() {
                try {
                    const response = await fetch(API_GET_PEOPLE);
                    const data = await response.json();
                    
                    personListElement.innerHTML = '';
                    let currentUserTickets = 0; // í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ í‹°ì¼“ ìˆ˜

                    if (response.ok && data.people && data.people.length > 0) {
                        data.people.forEach(person => {
                            // ê´€ë¦¬ìê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ëª©ë¡ì— ì¶”ê°€ (admin ê³„ì •ì€ ë£°ë › ëŒë¦¬ëŠ” ëŒ€ìƒì´ ì•„ë‹ˆë¯€ë¡œ ì œì™¸)
                            if (person.is_admin === false) { 
                                const listItem = document.createElement('li');
                                listItem.textContent = `${person.name}: `;
                                const span = document.createElement('span');
                                span.textContent = `${person.tickets}ê°œ`;
                                listItem.appendChild(span);
                                personListElement.appendChild(listItem);

                                // í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ í‹°ì¼“ ìˆ˜ ì €ì¥
                                if (person.name === loggedInUserName) {
                                    currentUserTickets = person.tickets;
                                }
                            }
                        });

                        // ë£°ë › ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”ëŠ” í˜„ì¬ ì‚¬ìš©ìì˜ ë£°ë ›ê¶Œì— ë”°ë¼ ê²°ì •
                        spinButton.disabled = currentUserTickets === 0; // ë³¸ì¸ í‹°ì¼“ì´ ì—†ìœ¼ë©´ ë¹„í™œì„±í™”
                        if (currentUserTickets === 0) {
                            resultDisplay.textContent = `ğŸ˜­ ${loggedInUserName}ë‹˜ì€ ë£°ë ›ê¶Œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`;
                            resultDisplay.style.color = 'orange';
                        } else {
                            // ë£°ë ›ê¶Œì´ ìˆì„ ë•Œë§Œ ì´ˆê¸° ë©”ì‹œì§€ë¥¼ ì§€ì›€ (ì´ë¯¸ ê½/ë‹¹ì²¨ ê²°ê³¼ ë©”ì‹œì§€ê°€ ì•„ë‹ˆë¼ë©´)
                            if (!resultDisplay.textContent.includes('ì¶•í•˜í•©ë‹ˆë‹¤') && 
                                !resultDisplay.textContent.includes('ê½ì…ë‹ˆë‹¤')) {
                                resultDisplay.textContent = ''; 
                            }
                        }

                    } else {
                        const listItem = document.createElement('li');
                        listItem.textContent = 'ë“±ë¡ëœ ì´ë¦„ì´ ì—†ìŠµë‹ˆë‹¤.';
                        personListElement.appendChild(listItem);
                        spinButton.disabled = true;
                        resultDisplay.textContent = 'í˜„ì¬ ë£°ë ›ê¶Œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.';
                        resultDisplay.style.color = 'orange';
                    }
                } catch (error) {
                    resultDisplay.textContent = 'ë£°ë ›ê¶Œ í˜„í™© ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜';
                    resultDisplay.style.color = 'red';
                    console.error('Network error fetching people for roulette:', error);
                    spinButton.disabled = true;
                }
            }

            spinButton.addEventListener('click', async () => {
                resultDisplay.textContent = 'ë£°ë ›ì„ ëŒë¦¬ëŠ” ì¤‘...';
                resultDisplay.style.color = '#666';
                spinButton.disabled = true; // ë²„íŠ¼ ë¹„í™œì„±í™”

                try {
                    // 1. í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ ë£°ë ›ê¶Œ ì •ë³´ë§Œ ê°€ì ¸ì˜¤ê¸° (ê°€ì¥ ìµœì‹  ìƒíƒœë¡œ í™•ì¸)
                    const peopleResponse = await fetch(API_GET_PEOPLE);
                    const peopleData = await peopleResponse.json();

                    if (!peopleResponse.ok || !peopleData.people) {
                        resultDisplay.textContent = 'ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                        resultDisplay.style.color = 'red';
                        spinButton.disabled = false;
                        return;
                    }

                    const currentUser = peopleData.people.find(p => p.name === loggedInUserName);

                    if (!currentUser) {
                        resultDisplay.textContent = 'ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                        resultDisplay.style.color = 'red';
                        spinButton.disabled = false;
                        return;
                    }

                    if (currentUser.tickets <= 0) {
                        resultDisplay.textContent = `ğŸ˜­ ${loggedInUserName}ë‹˜ì€ ë£°ë ›ê¶Œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`;
                        resultDisplay.style.color = 'orange';
                        spinButton.disabled = false;
                        return;
                    }

                    // --- ì—¬ê¸°ë¶€í„° ì¤‘ìš”! ë£°ë › ì• ë‹ˆë©”ì´ì…˜ 'ì²™'í•˜ê³  ê¸°ë‹¤ë¦¬ëŠ” ì‹œê°„ ---
                    // ì‹¤ì œ ë£°ë ›ì´ ëŒì•„ê°€ëŠ” ê²ƒì²˜ëŸ¼ ëŠë¼ê²Œ í•  ì§€ì—° ì‹œê°„ (ë°€ë¦¬ì´ˆ)
                    const spinDuration = 3000; // 3ì´ˆ ë™ì•ˆ ë£°ë ›ì´ ë„ëŠ” ê²ƒì²˜ëŸ¼!

                    // 2. 'ë‹¹ì²¨' ë˜ëŠ” 'ê½' ê²°ì • ë¡œì§ (30% í™•ë¥ ë¡œ ë‹¹ì²¨)
                    const isWin = Math.random() < 0.3; // âœ¨ 0.3ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ 30% ë‹¹ì²¨ìœ¨ ì ìš©! âœ¨

                    let tempResultText = 'ë‘ê·¼ë‘ê·¼... ê²°ê³¼ëŠ”?!'; // ë£°ë › ë„ëŠ” ì¤‘ í‘œì‹œí•  ë©”ì‹œì§€
                    let tempResultColor = '#666';

                    // ë¨¼ì € ë£°ë ›ì´ ë„ëŠ” ì¤‘ì´ë¼ëŠ” ë©”ì‹œì§€ë¥¼ í‘œì‹œ
                    resultDisplay.textContent = tempResultText;
                    resultDisplay.style.color = tempResultColor;

                    // spinDuration ì‹œê°„ í›„ì— ì‹¤ì œ ê²°ê³¼ì™€ ë£°ë ›ê¶Œ ì°¨ê° ë¡œì§ ì‹¤í–‰
                    setTimeout(async () => {
                        let finalResultText = '';
                        let resultColor = '';

                        if (isWin) {
                            finalResultText = `ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ${loggedInUserName}ë‹˜ ë‹¹ì²¨! ğŸ‰`;
                            resultColor = 'green';
                        } else {
                            finalResultText = `ğŸ˜‚ ${loggedInUserName}ë‹˜ ê½ì…ë‹ˆë‹¤! ë‹¤ìŒì— ë‹¤ì‹œ ë„ì „í•˜ì„¸ìš”! ğŸ˜‚`;
                            resultColor = 'red';
                        }

                        // 3. ë°±ì—”ë“œ API í˜¸ì¶œí•˜ì—¬ ë£°ë ›ê¶Œ ì°¨ê° (ë‹¹ì²¨ì´ë“  ê½ì´ë“  ë£°ë ›ê¶Œì€ ì†Œëª¨ë¨)
                        try {
                            const spinResponse = await fetch(API_SPIN_ROULETTE, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ name: loggedInUserName }) // í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì´ë¦„ ì „ë‹¬
                            });

                            const spinData = await spinResponse.json();

                            if (!spinResponse.ok) {
                                // ë£°ë ›ê¶Œ ì°¨ê° ì‹¤íŒ¨ ì‹œì—ë„ ê²°ê³¼ëŠ” ë³´ì—¬ì¤˜ì•¼ í•¨ (ì´ë¯¸ ì •í•´ì¡Œìœ¼ë‹ˆ)
                                resultDisplay.textContent = `ë£°ë ›ê¶Œ ì°¨ê° ì‹¤íŒ¨: ${spinData.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'} (í•˜ì§€ë§Œ ê²°ê³¼ëŠ” "${finalResultText.split('!')[0]}")`;
                                resultDisplay.style.color = 'orange'; // ì˜¤ë¥˜ì§€ë§Œ ê²°ê³¼ëŠ” ë³´ì´ê²Œ
                                spinButton.disabled = false; // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                                fetchPeopleForRoulette(); // ìµœì‹  í˜„í™© ì—…ë°ì´íŠ¸
                                return; // ì—¬ê¸°ì„œ í•¨ìˆ˜ ì¢…ë£Œ
                            }

                            // ë£°ë › ê²°ê³¼ í‘œì‹œ (ì´ì œ ìµœì¢… ê²°ê³¼)
                            resultDisplay.textContent = finalResultText;
                            resultDisplay.style.color = resultColor;

                            // --- ê²°ê³¼ ë©”ì‹œì§€ë¥¼ ìœ ì§€í•  ì‹œê°„ (ë°€ë¦¬ì´ˆ) ---
                            const resultDisplayDuration = 10000; // âœ¨ 10ì´ˆ (10000ms)ë¡œ ì„¤ì • âœ¨

                            setTimeout(() => {
                                resultDisplay.textContent = ''; // ë©”ì‹œì§€ ì´ˆê¸°í™”
                                resultDisplay.style.color = '#333'; // ìƒ‰ìƒë„ ê¸°ë³¸ìœ¼ë¡œ ëŒë ¤ë†“ê¸°
                                spinButton.disabled = false; // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                                fetchPeopleForRoulette(); // ìµœì‹  ë£°ë ›ê¶Œ í˜„í™© ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸° (ë©”ì‹œì§€ ì‚¬ë¼ì§„ í›„)
                            }, resultDisplayDuration);

                        } catch (spinError) {
                            // ë£°ë ›ê¶Œ ì°¨ê° API í˜¸ì¶œ ìì²´ì— ë¬¸ì œ ë°œìƒ ì‹œ
                            resultDisplay.textContent = `ë£°ë ›ê¶Œ ì°¨ê° ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë°œìƒ: ${spinError.message}`;
                            resultDisplay.style.color = 'red';
                            spinButton.disabled = false;
                            fetchPeopleForRoulette();
                        }

                    }, spinDuration); // spinDuration ë§Œí¼ ê¸°ë‹¤ë¦° í›„ ì´ ë¸”ë¡ ì‹¤í–‰

                } catch (error) {
                    // ì´ˆê¸° ì‚¬ìš©ì ì •ë³´ fetch ì‹¤íŒ¨ ì‹œ
                    resultDisplay.textContent = 'ì´ˆê¸° ë£°ë › ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜';
                    resultDisplay.style.color = 'red';
                    console.error('Error in initial roulette setup:', error);
                    spinButton.disabled = false;
                }
            });

            window.logout = async () => {
                try {
                    const response = await fetch(API_LOGOUT, { method: 'POST' });
                    if (response.ok) {
                        window.location.href = '/login'; // ë¡œê·¸ì•„ì›ƒ ì„±ê³µ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                    } else {
                        alert('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨!');
                    }
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('ë¡œê·¸ì•„ì›ƒ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë°œìƒ!');
                }
            };

            fetchPeopleForRoulette();
            setInterval(fetchPeopleForRoulette, 5000); // 5ì´ˆë§ˆë‹¤ í˜„í™© ì—…ë°ì´íŠ¸
        });
    </script>
</body>
</html>